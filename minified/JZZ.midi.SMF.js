!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r:"function"==typeof define&&define.amd?define("JZZ.midi.SMF",["JZZ"],r):r(JZZ)}(0,function(a){if(!a.MIDI.SMF){var s=a.lib.now;((o.prototype=[]).constructor=o).prototype.dup=function(t){p("Copy-constructor not yet implemented")},o.prototype.load=function(t){"RIFF"==t.substr(0,4)&&"RMIDdata"==t.substr(8,8)&&(t=t.substr(20,t.charCodeAt(16)+256*t.charCodeAt(17)+65536*t.charCodeAt(18)+16777216*t.charCodeAt(19))),this.loadSMF(t)},o.prototype.loadSMF=function(t){"MThd\0\0\0"!=t.substr(0,8)&&p("Not a MIDI file"),this.type=16*t.charCodeAt(8)+t.charCodeAt(9),this.ntrk=16*t.charCodeAt(10)+t.charCodeAt(11),127<t.charCodeAt(12)?(this.fps=256-t.charCodeAt(12),this.ppf=t.charCodeAt(13)):this.ppqn=256*t.charCodeAt(12)+t.charCodeAt(13),(2<this.type||0==this.type&&1<this.ntrk||!this.ppf&&!this.ppqn)&&p("Invalid MIDI header");for(var r=0,e=14;e<t.length;){var i=t.substr(e,4);"MTrk"==i&&r++;var a=(t.charCodeAt(e+4)<<24)+(t.charCodeAt(e+5)<<16)+(t.charCodeAt(e+6)<<8)+t.charCodeAt(e+7);e+=8;var s=t.substr(e,a);this.push(new d(i,s)),e+=a}e==t.length&&r==this.ntrk||p("Corrupted MIDI file")},o.prototype.dump=function(){for(var t="",r=0,e=0;e<this.length;e++)this[e]instanceof u&&r++,t+=this[e].dump();return t=(this.ppqn?String.fromCharCode(this.ppqn>>8)+String.fromCharCode(255&this.ppqn):String.fromCharCode(256-this.fps)+String.fromCharCode(this.ppf))+t,t="MThd\0\0\0\0"+String.fromCharCode(this.type)+String.fromCharCode(r>>8)+String.fromCharCode(255&r)+t},o.prototype.toString=function(){return"Midi File "+this.length},o.prototype.player=function(){var t,r=new f;r.ppqn=this.ppqn,r.fps=this.fps,r.ppf=this.ppf;var e=[];for(t=0;t<this.length;t++)this[t]instanceof u&&e.push(this[t]);2==this.type&&p("Playing MIDI file type 2 not yet implemented");var i=[];for(t=0;t<e.length;t++)i[t]=0;for(var a=0;;){var s,o=!0;for(t=0;t<e.length;t++){for(;i[t]<e[t].length&&e[t][i[t]].time==a;){var h=e[t][i[t]],n=new c;for(var d in h)h.hasOwnProperty(d)&&(n[d]=h[d]);n.track=t,r._data.push(n),i[t]++}i[t]>=e[t].length||(o&&(s=e[t][i[t]].time),o=!1,s>e[t][i[t]].time&&(s=e[t][i[t]].time))}if(a=s,o)break}return r},((d.prototype=[]).constructor=d).prototype.sub={MThd:function(){p("Illegal chunk type: MThd")},MTrk:function(t,r){return new u(r)}},d.prototype.dump=function(){var t=this.data.length;return this.type+String.fromCharCode(t>>24&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t)+this.data},((u.prototype=[]).constructor=u).prototype.dump=function(){for(var t,r,e="",i=0,a="",s=0;s<this.length;s++)t=this[s].time-i,i=this[s].time,2097151<t&&(e+=String.fromCharCode(128+(t>>21&127))),16383<t&&(e+=String.fromCharCode(128+(t>>14&127))),127<t&&(e+=String.fromCharCode(128+(t>>7&127))),e+=String.fromCharCode(127&t),255==this[s].status.charCodeAt(0)||240==this[s].status.charCodeAt(0)||247==this[s].status.charCodeAt(0)?(e+=this[s].status,2097151<(r=this[s].data.length)&&(e+=String.fromCharCode(128+(r>>21&127))),16383<r&&(e+=String.fromCharCode(128+(r>>14&127))),127<r&&(e+=String.fromCharCode(128+(r>>7&127))),e+=String.fromCharCode(127&r)):this[s].status!=a&&(a=this[s].status,e+=this[s].status),e+=this[s].data;return r=e.length,"MTrk"+String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(255&r)+e},u.prototype.getTime=function(){return this[this.length-1].time},u.prototype.setTime=function(t){t=parseInt(t),(isNaN(t)||t<0)&&p("Invalid parameter");var r=this[this.length-1];t<r.time&&p("not yet implemented"),r.time=t},u.prototype.addEvent=function(t,r,e){var i;t=parseInt(t),(isNaN(t)||t<0)&&p("Invalid parameter"),r=r.toString(),e=e.toString(),this.getTime()<t&&this.setTime(t);var a=this.eventOrder(r,e);for(i=0;i<this.length&&!(this[i].time>t)&&!(this[i].time==t&&this.eventOrder(this[i].status,this[i].data)>a);i++);this.splice(i,0,new c(t,r,e))},u.prototype.addMidi=function(){for(var t=arguments[0],r=[],e=1;e<arguments.length;e++)r.push(arguments[e]);var i=JZZ_.MIDI.apply(void 0,r).data(),a=i.charCodeAt(0);(a<128||254<a)&&p("Invalid MIDI message");var s=JZZ_.Midi.len(a);null!=s&&s!=i.length&&p("Invalid MIDI message"),this.addEvent(t,i.substr(0,1),i.substr(1))},u.prototype.addNote=function(t,r,e,i,a){var s=parseInt(e);isNaN(s)&&(s=parseInt(JZZ_.Midi[e])),(isNaN(s)||s<0||127<s)&&p("Invalid parameter"),r=parseInt(r),(isNaN(r)||r<0||15<r)&&p("Invalid parameter"),null==a&&(a=0),a=parseInt(a),(isNaN(a)||a<0)&&p("Invalid parameter"),null==i&&(i=127),i=parseInt(i),(isNaN(i)||i<0||127<i)&&p("Invalid parameter"),this.addMidi(t,144+r,s,i),a&&this.addMidi(t+a,144+r,s,0)},u.prototype.addName=function(t,r){this.addEvent(t,"ÿ",r)},u.prototype.addText=function(t,r){this.addEvent(t,"ÿ",r)},u.prototype.addTempo=function(t,r){var e=Math.round(6e7/r),i=String.fromCharCode(255&e>>16)+String.fromCharCode(255&e>>8)+String.fromCharCode(255&e);this.addEvent(t,"ÿQ",i)},c.prototype.toString=function(){var t,r,e=this.status.charCodeAt(0);if(127<e&&255!=e&&240!=e&&247!=e)return JZZ_.MIDI(this.status+this.data).toString();if(255==e){var i=this.status.charCodeAt(1);if(t="ff"+(15<i?"":"0")+i.toString(16)+" ",0==i)return t+="Sequence number: "+this.data.charCodeAt(0);if(i<10)return t+={1:"Text",2:"Copyright",3:"Track name",4:"Instrument",5:"Lyrics",6:"Marker",7:"Cue point",8:"Program name",9:"Device name"}[i],t+=": "+this.data;if(32==i)t+="MIDI channel: ";else if(33==i)t+="MIDI port: ";else{if(47==i)return t+="End of track";if(81==i){var a=65536*this.data.charCodeAt(0)+256*this.data.charCodeAt(1)+this.data.charCodeAt(2);return t+="Tempo: "+Math.round(6e9/a)/100+" bpm"}if(84==i){for(t+="SMPTE offset: "+(9<this.data.charCodeAt(0)?"":"0")+this.data.charCodeAt(0).toString(),r=1;r<this.data.length;r++)t+=":"+(9<this.data.charCodeAt(r)?"":"0")+this.data.charCodeAt(r);return t}if(88==i){var s=1<<this.data.charCodeAt(1);return t+="Time signature: "+this.data.charCodeAt(0)+"/"+s,t+=" "+this.data.charCodeAt(2)+" "+this.data.charCodeAt(3)}if(89==i){t+="Key signature: ";var o=this.data.charCodeAt(0),h=this.data.charCodeAt(1);if(128&o&&(o-=256),0<=(o+=7)&&o<=14&&0<=h&&h<=1)return h&&(o+=3),t+=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#","G#","D#","A#"][o],h&&(t+="min"),t}else 127==i&&(t+="Proprietary event: ")}}else t=240==e?"SysEx: f0":247==e?"SysEx cont.:":(15<e?"":"0")+e.toString(16);for(r=0;r<this.data.length;r++)t+=" "+(15<this.data.charCodeAt(r)?"":"0")+this.data.charCodeAt(r).toString(16);return t},((f.prototype=new a.Widget).constructor=f).prototype.onEnd=function(){},f.prototype.onData=function(){},f.prototype.loop=function(t){this.looped=!!t},f.prototype.play=function(){this.ppqn?this.mul=this.ppqn/500:this.mul=this.fps*this.ppf/1e3,this.playing=!0,this.ptr=0,this.c0=0,this.t0=s(),this.tick()},f.prototype.stop=function(){this.event="stop",this.paused=void 0},f.prototype.pause=function(){this.event="pause",this.playing=!1},f.prototype.resume=function(){if(!this.playing&&null!=this.paused){s();this.t0+=s()-this.paused,this.playing=!0,this.tick()}},f.prototype.sndOff=function(){for(var t=0;t<16;t++)this._emit(a.MIDI.allSoundOff(t))},f.prototype.tick=function(){for(var t,r,e=s(),i=this.c0+(e-this.t0)*this.mul;this.ptr<this._data.length&&!((t=this._data[this.ptr]).time>i);this.ptr++)r={},"ÿQ"==t.status&&this.ppqn?(this.mul=1e3*this.ppqn/((t.data.charCodeAt(0)<<16)+(t.data.charCodeAt(1)<<8)+t.data.charCodeAt(2)),this.t0=e,this.c0=i):247==t.status.charCodeAt(0)?r.midi=t.data:255!=t.status.charCodeAt(0)?r.midi=t.status+t.data:(r.status=t.status,r.data=t.data),r.track=t.track,void 0!==t.user&&(r.user=t.user),r.midi?this._emit(C(r.midi)):this.onData(t);this.ptr>=this._data.length&&(this.onEnd(),this.looped?(this.ptr=0,this.c0=0,this.t0=e):this.stop()),"stop"==this.event&&(this.playing=!1,this.sndOff(),this.event=void 0),this.playing?a.lib.schedule(this._tick):"pause"==this.event&&(this.paused=e,this.sndOff(),this.event=void 0)},a.MIDI.SMF=o}function p(t){throw new Error(t)}function o(){var t,r,e=1,i=96;if(1==arguments.length){if(arguments[0]instanceof o)return void this.dup(arguments[0]);if("string"==typeof arguments[0]&&"0"!=arguments[0]&&"1"!=arguments[0]&&"2"!=arguments[0])return void this.load(arguments[0]);e=parseInt(arguments[0])}else 2==arguments.length?(e=parseInt(arguments[0]),i=parseInt(arguments[1])):3==arguments.length?(e=parseInt(arguments[0]),t=parseInt(arguments[1]),r=parseInt(arguments[2])):arguments.length&&p("Invalid parameters");(isNaN(e)||e<0||2<e)&&p("Invalid parameters"),this.type=e,null==t?((isNaN(i)||i<0||65535<e)&&p("Invalid parameters"),this.ppqn=i):(24!=t&&25!=t&&29!=t&&30!=t&&p("Invalid parameters"),(isNaN(r)||r<0||255<e)&&p("Invalid parameters"),this.fps=t,this.ppf=r)}function h(t){if(t.charCodeAt(0)<128)return t.charCodeAt(0);var r=127&t.charCodeAt(0);return r<<=7,t.charCodeAt(1)<128?r+t.charCodeAt(1):(r+=127&t.charCodeAt(1),r<<=7,t.charCodeAt(2)<128?r+t.charCodeAt(2):(r+=127&t.charCodeAt(2),r<<=7,t.charCodeAt(3)<128?r+t.charCodeAt(3):void p("Corrupted MIDI track")))}function n(t){switch(240&t){case 128:case 144:case 160:case 176:case 224:return 2;case 192:case 208:return 1;default:p("Corrupted MIDI track")}}function d(t,r){if(this.sub[t])return this.sub[t](t,r);"string"==typeof t&&4==t.length||p("Invalid chunk type: "+t),this.type=t,this.data=r}function u(t){if(null!=t)for(var r,e,i,a=0,s=0,o="";s<t.length;)r=h(t.substr(s,4)),s++,127<r&&s++,16383<r&&s++,2097151<r&&s++,a+=r,255==t.charCodeAt(s)?(e=t.substr(s,2),s+=2,i=h(t.substr(s,4)),s++,127<i&&s++,16383<i&&s++,2097151<i&&s++,this.push(new c(a,e,t.substr(s,i))),s+=i):240==t.charCodeAt(s)||247==t.charCodeAt(s)?(e=t.substr(s,1),s+=1,i=h(t.substr(s,4)),s++,127<i&&s++,16383<i&&s++,2097151<i&&s++,this.push(new c(a,e,t.substr(s,i))),s+=i):128&t.charCodeAt(s)?(o=t.substr(s,1),s+=1,i=n(o.charCodeAt(0)),this.push(new c(a,o,t.substr(s,i))),s+=i):128&o.charCodeAt(0)&&(i=n(o.charCodeAt(0)),this.push(new c(a,o,t.substr(s,i))),s+=i);else this.push(new c(0,"ÿ/",""))}function c(t,r,e){this.time=t,this.status=r,this.data=e}function f(){var t;this.playing=!1,this.looped=!1,this._data=[],this._tick=(t=this,function(){t.tick()})}function C(t){var r,e=[];for(r=0;r<t.length;r++)e.push(t.charCodeAt(r));return a.MIDI(e)}});