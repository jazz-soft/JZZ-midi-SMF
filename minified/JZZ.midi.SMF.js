!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i:"function"==typeof define&&define.amd?define("JZZ.midi.SMF",["JZZ"],i):i(JZZ)}(0,function(r){if(!r.MIDI.SMF){var o="0.0.9",a=r.lib.now;((h.prototype=[]).constructor=h).prototype.dup=function(t){d("Copy-constructor not yet implemented")},h.prototype.load=function(t){"RIFF"==t.substr(0,4)&&"RMIDdata"==t.substr(8,8)&&(t=t.substr(20,t.charCodeAt(16)+256*t.charCodeAt(17)+65536*t.charCodeAt(18)+16777216*t.charCodeAt(19))),this.loadSMF(t)},h.prototype.loadSMF=function(t){"MThd\0\0\0"!=t.substr(0,8)&&d("Not a MIDI file"),this.type=16*t.charCodeAt(8)+t.charCodeAt(9),this.ntrk=16*t.charCodeAt(10)+t.charCodeAt(11),127<t.charCodeAt(12)?(this.fps=256-t.charCodeAt(12),this.ppf=t.charCodeAt(13)):this.ppqn=256*t.charCodeAt(12)+t.charCodeAt(13),(2<this.type||0==this.type&&1<this.ntrk||!this.ppf&&!this.ppqn)&&d("Invalid MIDI header");for(var i=0,s=14;s<t.length;){var r=t.substr(s,4);"MTrk"==r&&i++;var e=(t.charCodeAt(s+4)<<24)+(t.charCodeAt(s+5)<<16)+(t.charCodeAt(s+6)<<8)+t.charCodeAt(s+7);s+=8;var o=t.substr(s,e);this.push(new u(r,o)),s+=e}s==t.length&&i==this.ntrk||d("Corrupted MIDI file")},h.prototype.dump=function(){for(var t="",i=0,s=0;s<this.length;s++)this[s]instanceof f&&i++,t+=this[s].dump();return t=(this.ppqn?String.fromCharCode(this.ppqn>>8)+String.fromCharCode(255&this.ppqn):String.fromCharCode(256-this.fps)+String.fromCharCode(this.ppf))+t,t="MThd\0\0\0\0"+String.fromCharCode(this.type)+String.fromCharCode(i>>8)+String.fromCharCode(255&i)+t},h.prototype.toString=function(){return"Midi File "+this.length},h.prototype.player=function(){var t,i=new C;i.ppqn=this.ppqn,i.fps=this.fps,i.ppf=this.ppf;var s=[];for(t=0;t<this.length;t++)this[t]instanceof f&&s.push(this[t]);2==this.type&&d("Playing MIDI file type 2 not yet implemented");var r=[];for(t=0;t<s.length;t++)r[t]=0;for(var e=0;;){var o,a=!0;for(t=0;t<s.length;t++){for(;r[t]<s[t].length&&s[t][r[t]].time==e;){var h=s[t][r[t]],n=new c;for(var p in h)h.hasOwnProperty(p)&&(n[p]=h[p]);n.track=t,i._data.push(n),r[t]++}r[t]>=s[t].length||(a&&(o=s[t][r[t]].time),a=!1,o>s[t][r[t]].time&&(o=s[t][r[t]].time))}if(e=o,a)break}return i._duration=e,i},((u.prototype=[]).constructor=u).prototype.sub={MThd:function(){d("Illegal chunk type: MThd")},MTrk:function(t,i){return new f(i)}},u.prototype.dump=function(){var t=this.data.length;return this.type+String.fromCharCode(t>>24&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t)+this.data},((f.prototype=[]).constructor=f).prototype.dump=function(){for(var t,i,s="",r=0,e="",o=0;o<this.length;o++)t=this[o].time-r,r=this[o].time,2097151<t&&(s+=String.fromCharCode(128+(t>>21&127))),16383<t&&(s+=String.fromCharCode(128+(t>>14&127))),127<t&&(s+=String.fromCharCode(128+(t>>7&127))),s+=String.fromCharCode(127&t),255==this[o].status.charCodeAt(0)||240==this[o].status.charCodeAt(0)||247==this[o].status.charCodeAt(0)?(s+=this[o].status,2097151<(i=this[o].data.length)&&(s+=String.fromCharCode(128+(i>>21&127))),16383<i&&(s+=String.fromCharCode(128+(i>>14&127))),127<i&&(s+=String.fromCharCode(128+(i>>7&127))),s+=String.fromCharCode(127&i)):this[o].status!=e&&(e=this[o].status,s+=this[o].status),s+=this[o].data;return i=s.length,"MTrk"+String.fromCharCode(i>>24&255)+String.fromCharCode(i>>16&255)+String.fromCharCode(i>>8&255)+String.fromCharCode(255&i)+s},f.prototype.getTime=function(){return this[this.length-1].time},f.prototype.setTime=function(t){t=parseInt(t),(isNaN(t)||t<0)&&d("Invalid parameter");var i=this[this.length-1];t<i.time&&d("not yet implemented"),i.time=t},f.prototype.addEvent=function(t,i,s){var r;t=parseInt(t),(isNaN(t)||t<0)&&d("Invalid parameter"),i=i.toString(),s=s.toString(),this.getTime()<t&&this.setTime(t);var e=this.eventOrder(i,s);for(r=0;r<this.length&&!(this[r].time>t)&&!(this[r].time==t&&this.eventOrder(this[r].status,this[r].data)>e);r++);this.splice(r,0,new c(t,i,s))},f.prototype.addMidi=function(){for(var t=arguments[0],i=[],s=1;s<arguments.length;s++)i.push(arguments[s]);var r=JZZ_.MIDI.apply(void 0,i).data(),e=r.charCodeAt(0);(e<128||254<e)&&d("Invalid MIDI message");var o=JZZ_.Midi.len(e);void 0!==o&&o!=r.length&&d("Invalid MIDI message"),this.addEvent(t,r.substr(0,1),r.substr(1))},f.prototype.addNote=function(t,i,s,r,e){var o=parseInt(s);isNaN(o)&&(o=parseInt(JZZ_.Midi[s])),(isNaN(o)||o<0||127<o)&&d("Invalid parameter"),i=parseInt(i),(isNaN(i)||i<0||15<i)&&d("Invalid parameter"),void 0===e&&(e=0),e=parseInt(e),(isNaN(e)||e<0)&&d("Invalid parameter"),void 0===r&&(r=127),r=parseInt(r),(isNaN(r)||r<0||127<r)&&d("Invalid parameter"),this.addMidi(t,144+i,o,r),e&&this.addMidi(t+e,144+i,o,0)},f.prototype.addName=function(t,i){this.addEvent(t,"ÿ",i)},f.prototype.addText=function(t,i){this.addEvent(t,"ÿ",i)},f.prototype.addTempo=function(t,i){var s=Math.round(6e7/i),r=String.fromCharCode(255&s>>16)+String.fromCharCode(255&s>>8)+String.fromCharCode(255&s);this.addEvent(t,"ÿQ",r)},C.prototype.onEnd=function(){},C.prototype.onData=function(){},C.prototype.loop=function(t){t==parseInt(t)&&0<t?this._loop=t:this._loop=t?-1:0},C.prototype.play=function(){this.ppqn?this.mul=this.ppqn/500:this.mul=this.fps*this.ppf/1e3,this.event=void 0,this.playing=!0,this.paused=!1,this._ptr=0,this._pos=0,this._p0=0,this._t0=a(),this.tick()},C.prototype.stop=function(){this._pos=0,this.event="stop",this.paused=void 0},C.prototype.pause=function(){this.event="pause"},C.prototype.resume=function(){this.playing||(this.paused?(this.event=void 0,this._t0=a(),this.playing=!0,this.paused=!1,this.tick()):this.play())},C.prototype.sndOff=function(){for(var t=0;t<16;t++)this._emit(r.MIDI.allSoundOff(t))},C.prototype.tick=function(){var t,i,s=a();for(this._pos=this._p0+(s-this._t0)*this.mul;this._ptr<this._data.length&&!((t=this._data[this._ptr]).time>this._pos);this._ptr++)i={},"ÿQ"==t.status&&this.ppqn?(this.mul=1e3*this.ppqn/((t.data.charCodeAt(0)<<16)+(t.data.charCodeAt(1)<<8)+t.data.charCodeAt(2)),this._p0=this._pos-(s-this._t0)*this.mul):247==t.status.charCodeAt(0)?i.midi=t.data:255!=t.status.charCodeAt(0)?i.midi=t.status+t.data:(i.status=t.status,i.data=t.data),i.track=t.track,void 0!==t.user&&(i.user=t.user),i.midi?this._emit(l(i.midi)):this.onData(t);this._ptr>=this._data.length&&(this._loop&&-1!=this._loop&&this._loop--,this._loop?(this._ptr=0,this._p0=0,this._t0=s):this.stop(),this.onEnd()),"stop"==this.event&&(this.playing=!1,this.paused=!1,this._pos=0,this._ptr=0,this.sndOff(),this.event=void 0),"pause"==this.event&&(this.playing=!1,this.paused=!0,this._pos>=this._duration&&(this._pos=this._duration-1),this._p0=this._pos,this.sndOff(),this.event=void 0),this.playing&&r.lib.schedule(this._tick)},C.prototype.duration=function(){return this._duration},C.prototype.position=function(){return this._pos},C.prototype.jump=function(t){isNaN(parseFloat(t))&&d("Not a number: "+t),t<0&&(t=0),t>=this._duration&&(t=this._duration-1),this._pos=t,this._p0=t,this._t0=a(),this.playing||(this.paused=!!t),this._toPos(),this.playing&&this.sndOff()},C.prototype._toPos=function(){for(this._ptr=0;this._ptr<this._data.length&&(e=this._data[this._ptr],!(e.time>=this._pos));this._ptr++)"ÿQ"==e.status&&this.ppqn&&(this.mul=1e3*this.ppqn/((e.data.charCodeAt(0)<<16)+(e.data.charCodeAt(1)<<8)+e.data.charCodeAt(2)),this._p0=this._pos-(a()-this._t0)*this.mul)},r.MIDI.SMF=h}function d(t){throw new Error(t)}function h(){var t,i,s=1,r=96;if(1==arguments.length){if(arguments[0]instanceof h)return void this.dup(arguments[0]);if("string"==typeof arguments[0]&&"0"!=arguments[0]&&"1"!=arguments[0]&&"2"!=arguments[0])return void this.load(arguments[0]);s=parseInt(arguments[0])}else 2==arguments.length?(s=parseInt(arguments[0]),r=parseInt(arguments[1])):3==arguments.length?(s=parseInt(arguments[0]),t=parseInt(arguments[1]),i=parseInt(arguments[2])):arguments.length&&d("Invalid parameters");(isNaN(s)||s<0||2<s)&&d("Invalid parameters"),this.type=s,void 0===t?((isNaN(r)||r<0||65535<s)&&d("Invalid parameters"),this.ppqn=r):(24!=t&&25!=t&&29!=t&&30!=t&&d("Invalid parameters"),(isNaN(i)||i<0||255<s)&&d("Invalid parameters"),this.fps=t,this.ppf=i)}function n(t){if(t.charCodeAt(0)<128)return t.charCodeAt(0);var i=127&t.charCodeAt(0);return i<<=7,t.charCodeAt(1)<128?i+t.charCodeAt(1):(i+=127&t.charCodeAt(1),i<<=7,t.charCodeAt(2)<128?i+t.charCodeAt(2):(i+=127&t.charCodeAt(2),i<<=7,t.charCodeAt(3)<128?i+t.charCodeAt(3):void d("Corrupted MIDI track")))}function p(t){switch(240&t){case 128:case 144:case 160:case 176:case 224:return 2;case 192:case 208:return 1;default:d("Corrupted MIDI track")}}function u(t,i){if(this.sub[t])return this.sub[t](t,i);"string"==typeof t&&4==t.length||d("Invalid chunk type: "+t),this.type=t,this.data=i}function f(t){if(void 0!==t)for(var i,s,r,e=0,o=0,a="";o<t.length;)i=n(t.substr(o,4)),o++,127<i&&o++,16383<i&&o++,2097151<i&&o++,e+=i,255==t.charCodeAt(o)?(s=t.substr(o,2),o+=2,r=n(t.substr(o,4)),o++,127<r&&o++,16383<r&&o++,2097151<r&&o++,this.push(new c(e,s,t.substr(o,r))),o+=r):240==t.charCodeAt(o)||247==t.charCodeAt(o)?(s=t.substr(o,1),o+=1,r=n(t.substr(o,4)),o++,127<r&&o++,16383<r&&o++,2097151<r&&o++,this.push(new c(e,s,t.substr(o,r))),o+=r):128&t.charCodeAt(o)?(a=t.substr(o,1),o+=1,r=p(a.charCodeAt(0)),this.push(new c(e,a,t.substr(o,r))),o+=r):128&a.charCodeAt(0)&&(r=p(a.charCodeAt(0)),this.push(new c(e,a,t.substr(o,r))),o+=r);else this.push(new c(0,"ÿ/",""))}function c(t,i,s){this.time=t,this.status=i,this.data=s}function C(){var t,i=new r.Widget;for(var s in i._info.name="MIDI Player",i._info.manufacturer="Jazz-Soft",i._info.version=o,i.playing=!1,i._loop=0,i._data=[],i._pos=0,i._tick=(t=i,function(){t.tick()}),C.prototype)C.prototype.hasOwnProperty(s)&&(i[s]=C.prototype[s]);return i}function l(t){var i,s=[];for(i=0;i<t.length;i++)s.push(t.charCodeAt(i));return r.MIDI(s)}});