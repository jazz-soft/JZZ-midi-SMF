!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i:"function"==typeof define&&define.amd?define("JZZ.midi.SMF",["JZZ"],i):i(JZZ)}(0,function(a){if(!a.MIDI.SMF){var s="1.1.3",r=a.lib.now;d.version=function(){return s},((d.prototype=[]).constructor=d).prototype.copy=function(){var t=new d;t.type=this.type,t.ppqn=this.ppqn,t.fps=this.fps,t.ppf=this.ppf,t.rmi=this.rmi,t.ntrk=this.ntrk;for(var i=0;i<this.length;i++)t.push(this[i].copy());return t},d.prototype.load=function(t){"RIFF"==t.substr(0,4)&&"RMIDdata"==t.substr(8,8)&&(this.rmi=!0,t=t.substr(20,t.charCodeAt(16)+256*t.charCodeAt(17)+65536*t.charCodeAt(18)+16777216*t.charCodeAt(19))),this.loadSMF(t)};var h="MThd"+String.fromCharCode(0)+String.fromCharCode(0)+String.fromCharCode(0)+String.fromCharCode(6);d.prototype.loadSMF=function(t){t.length||p("Empty file"),t.substr(0,8)!=h&&p("Not a MIDI file"),this.type=16*t.charCodeAt(8)+t.charCodeAt(9),this.ntrk=16*t.charCodeAt(10)+t.charCodeAt(11),127<t.charCodeAt(12)?(this.fps=256-t.charCodeAt(12),this.ppf=t.charCodeAt(13)):this.ppqn=256*t.charCodeAt(12)+t.charCodeAt(13),(2<this.type||0==this.type&&1<this.ntrk||!this.ppf&&!this.ppqn)&&p("Invalid MIDI header");var i=0,r=14;for(this.warn=[];r<t.length-8;){var s=t.substr(r,4);"MTrk"==s&&i++;var o=(t.charCodeAt(r+4)<<24)+(t.charCodeAt(r+5)<<16)+(t.charCodeAt(r+6)<<8)+t.charCodeAt(r+7);r+=8;var n=t.substr(r,o);this.push(new l(s,n)),r+=o}i!=this.ntrk&&p("Corrupted MIDI file"),r<t.length&&this.warn.push(["extra",t.length-r]),r>t.length&&this.warn.push(["missing",r-t.length])},d.prototype.dump=function(t){var i="";if(t)return"RIFF"+f((i=this.dump()).length+12)+"RMIDdata"+f(i.length)+i;for(var r=this.ntrk=0;r<this.length;r++)this[r]instanceof g&&this.ntrk++,i+=this[r].dump();return i=(this.ppqn?o(this.ppqn):String.fromCharCode(256-this.fps)+String.fromCharCode(this.ppf))+i,i=h+String.fromCharCode(0)+String.fromCharCode(this.type)+o(this.ntrk)+i},d.prototype.toString=function(){var t;for(t=this.ntrk=0;t<this.length;t++)this[t]instanceof g&&this.ntrk++;var i=["SMF:","  type: "+this.type];for(this.ppqn?i.push("  ppqn: "+this.ppqn):i.push("  fps: "+this.fps,"  ppf: "+this.ppf),i.push("  tracks: "+this.ntrk),t=0;t<this.length;t++)i.push(this[t].toString());return i.join("\n")},d.prototype.player=function(){var t,i,r=new y;r.ppqn=this.ppqn,r.fps=this.fps,r.ppf=this.ppf;var s,o=[],n=0,h=0;for(t=0;t<this.length;t++)this[t]instanceof g&&o.push(this[t]);if(2==this.type)for(t=0;t<o.length;t++){for(i=0;i<o[t].length;i++)(s=a.MIDI(o[t][i])).track=t,h=s.tt+n,s.tt=h,r._data.push(s);n=h}else{var e=[];for(t=0;t<o.length;t++)e[t]=0;for(;;){var p=!0;for(t=0;t<o.length;t++){for(;e[t]<o[t].length&&o[t][e[t]].tt==h;)(s=a.MIDI(o[t][e[t]])).track=t,r._data.push(s),e[t]++;e[t]>=o[t].length||(p&&(n=o[t][e[t]].tt),p=!1,n>o[t][e[t]].tt&&(n=o[t][e[t]].tt))}if(h=n,p)break}}if(r._duration=h,r._ttt=[],r.ppqn){for(r.mul=r.ppqn/500,n=r.mul,h=0,r._durationMS=0,r._ttt.push({t:0,m:n,ms:0}),t=0;t<r._data.length;t++)81==(s=r._data[t]).ff&&(r._durationMS+=(s.tt-h)/n,h=s.tt,n=1e3*this.ppqn/((s.dd.charCodeAt(0)<<16)+(s.dd.charCodeAt(1)<<8)+s.dd.charCodeAt(2)),r._ttt.push({t:h,m:n,ms:r._durationMS}));r._durationMS+=(r._duration-h)/n}else r.mul=r.fps*r.ppf/1e3,r._ttt.push({t:0,m:r.mul,ms:0}),r._durationMS=h/r.mul;return r._ttt.push({t:r._duration,m:0,ms:r._durationMS}),r._durationMS||(r._durationMS=1),r._type=this.type,r._tracks=o.length,r},(((d.Chunk=l).prototype=[]).constructor=l).prototype.copy=function(){return new l(this.type,this.data)},l.prototype.sub={MTrk:function(t,i){return new g(i)}},l.prototype.dump=function(){return this.type+u(this.data.length)+this.data},l.prototype.toString=function(){return this.type+": "+this.data.length+" bytes"},(((d.MTrk=g).prototype=[]).constructor=g).prototype.copy=function(){for(var t=new g,i=t.length=0;i<this.length;i++)t.push(new a.MIDI(this[i]));return t},g.prototype.dump=function(){var t,i,r="",s=0,o="";for(t=0;t<this.length;t++)if(r+=n(this[t].tt-s),s=this[t].tt,void 0!==this[t].dd)r+="ÿ",r+=String.fromCharCode(this[t].ff),r+=n(this[t].dd.length),r+=this[t].dd;else if(240==this[t][0]||247==this[t][0])for(r+=String.fromCharCode(this[t][0]),r+=n(this[t].length-1),i=1;i<this[t].length;i++)r+=String.fromCharCode(this[t][i]);else for(this[t][0]!=o&&(o=this[t][0],r+=String.fromCharCode(this[t][0])),i=1;i<this[t].length;i++)r+=String.fromCharCode(this[t][i]);return"MTrk"+u(r.length)+r},g.prototype.toString=function(){for(var t=["MTrk:"],i=0;i<this.length;i++)t.push(this[i].tt+": "+this[i].toString());return t.join("\n  ")},g.prototype.add=function(t,i){if(t=parseInt(t),(isNaN(t)||t<0)&&p("Invalid parameter"),(i=a.MIDI(i)).tt=t,this[this.length-1].tt<t&&(this[this.length-1].tt=t),47==i.ff||255==i[0])return this;var r,s=C(i);for(r=0;r<this.length&&!(this[r].tt>t)&&!(this[r].tt==t&&C(this[r])>s);r++);return this.splice(r,0,i),this},g.prototype.send=function(t){this._orig.add(this._tick,t)},g.prototype.tick=function(t){if(t!=parseInt(t)||t<0)throw RangeError("Bad tick value: "+t);if(!t)return this;var i=function(){};i.prototype=this._orig;var r=new i;return r._tick=this._tick+t,r},g.prototype.note=function(t,i,r,s){return this.noteOn(t,i,r),0<s&&this.tick(s).noteOff(t,i),this},g.prototype.ch=function(t){if(void 0===t)return this;if(t!=parseInt(t)||t<0||15<t)throw RangeError("Bad channel value: "+t+" (must be from 0 to 15)");return new i(this._orig,t,this._tick)},(i.prototype=new g).tick=function(t){if(t!=parseInt(t)||t<0)throw RangeError("Bad tick value: "+t);return t?new i(this._orig,this._chan,this._tick+t):this},i.prototype.ch=function(t){if(void 0===t)return this._orig.tick(this._tick);if(t!=parseInt(t)||t<0||15<t)throw RangeError("Bad channel value: "+t+" (must be from 0 to 15)");return t==this._chan?this:new i(this._orig,t,this._tick)},i.prototype.note=function(t,i,r){return this.noteOn(t,i),r&&this.tick(r).noteOff(t),this},a.lib.copyMidiHelpers(g,i),y.prototype.onEnd=function(){},y.prototype.onData=function(){},y.prototype.loop=function(t){t==parseInt(t)&&0<t?this._loop=t:this._loop=t?-1:0},y.prototype.play=function(){this.event=void 0,this.playing=!0,this.paused=!1,this._ptr=0,this._pos=0,this._ms=0,this._p0=0,this._st=r(),this._t0=this._st,this.tick()},y.prototype.stop=function(){this._pos=0,this._ms=0,this.playing=!1,this.event="stop",this.paused=void 0},y.prototype.pause=function(){this.event="pause"},y.prototype.resume=function(){this.playing||(this.paused?(this.event=void 0,this._st=r(),this._t0=this._st,this.playing=!0,this.paused=!1,this.tick()):this.play())},y.prototype.sndOff=function(){for(var t=0;t<16;t++)this._emit(a.MIDI.allSoundOff(t))},y.prototype.tick=function(){var t,i=r();for(this._pos=this._p0+(i-this._t0)*this.mul;this._ptr<this._data.length&&!((t=this._data[this._ptr]).tt>this._pos);this._ptr++)81==t.ff&&this.ppqn&&(this.mul=1e3*this.ppqn/((t.dd.charCodeAt(0)<<16)+(t.dd.charCodeAt(1)<<8)+t.dd.charCodeAt(2)),this._p0=this._pos-(i-this._t0)*this.mul),this._emit(t);this._ptr>=this._data.length&&(this._loop&&-1!=this._loop&&this._loop--,this._loop?(this._ptr=0,this._p0=0,this._t0=i,this._st=i,this._ms=0):this.stop(),this.onEnd()),"stop"==this.event&&(this.playing=!1,this.paused=!1,this._pos=0,this._ms=0,this._ptr=0,this.sndOff(),this.event=void 0),"pause"==this.event&&(this.playing=!1,this.paused=!0,this._ms+=r()-this._st,this._pos>=this._duration&&(this._pos=this._duration-1),this._p0=this._pos,this.sndOff(),this.event=void 0),this.playing&&a.lib.schedule(this._tick)},y.prototype.type=function(){return this._type},y.prototype.tracks=function(){return this._tracks},y.prototype.duration=function(){return this._duration},y.prototype.durationMS=function(){return this._durationMS},y.prototype.position=function(){return this._pos},y.prototype.positionMS=function(){return this.playing?this._ms+r()-this._st:this._ms},y.prototype.jump=function(t){isNaN(parseFloat(t))&&p("Not a number: "+t),t<0&&(t=0),t>=this._duration&&(t=this._duration-1),this._goto(t,this._t2ms(t))},y.prototype.jumpMS=function(t){isNaN(parseFloat(t))&&p("Not a number: "+t),t<0&&(t=0),t>=this._durationMS&&(t=this._durationMS-1),this._goto(this._ms2t(t),t)},y.prototype._t2ms=function(t){if(!t)return 0;var i;for(i=0;this._ttt[i].t<t;i++);return i--,this._ttt[i].ms+(t-this._ttt[i].t)/this._ttt[i].m},y.prototype._ms2t=function(t){if(!t)return 0;var i;for(i=0;this._ttt[i].ms<t;i++);return i--,this._ttt[i].t+(t-this._ttt[i].ms)*this._ttt[i].m},y.prototype._goto=function(t,i){this._pos=t,this._ms=i,this._p0=t,this._t0=r(),this._st=this._t0,this.playing||(this.paused=!!t),this._toPos(),this.playing&&this.sndOff()},y.prototype._toPos=function(){for(this._ptr=0;this._ptr<this._data.length&&(e=this._data[this._ptr],!(e.tt>=this._pos));this._ptr++)81==e.ff&&this.ppqn&&(this.mul=1e3*this.ppqn/((e.dd.charCodeAt(0)<<16)+(e.dd.charCodeAt(1)<<8)+e.dd.charCodeAt(2)),this._p0=this._pos-(r()-this._t0)*this.mul)},y.prototype.tick2ms=function(t){return isNaN(parseFloat(t))&&p("Not a number: "+t),t<=0?0:t>=this._duration?this._durationMS:this._t2ms(t)},y.prototype.ms2tick=function(t){return isNaN(parseFloat(t))&&p("Not a number: "+t),t<=0?0:t>=this._durationMS?this._duration:this._ms2t(t)},a.MIDI.SMF=d}function p(t){throw new Error(t)}function n(t){var i="";return 2097151<t&&(i+=String.fromCharCode(128+(t>>21&127))),16383<t&&(i+=String.fromCharCode(128+(t>>14&127))),127<t&&(i+=String.fromCharCode(128+(t>>7&127))),i+=String.fromCharCode(127&t)}function o(t){return String.fromCharCode(t>>8)+String.fromCharCode(255&t)}function u(t){return String.fromCharCode(t>>24&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t)}function f(t){return String.fromCharCode(255&t)+String.fromCharCode(t>>8&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>24&255)}function d(){var t,i,r=this instanceof d?this:r=new d,s=1,o=96;if(1==arguments.length){if(arguments[0]instanceof d)return arguments[0].copy();if("string"==typeof arguments[0]&&"0"!=arguments[0]&&"1"!=arguments[0]&&"2"!=arguments[0])return r.load(arguments[0]),r;s=parseInt(arguments[0])}else 2==arguments.length?(s=parseInt(arguments[0]),o=parseInt(arguments[1])):3==arguments.length?(s=parseInt(arguments[0]),t=parseInt(arguments[1]),i=parseInt(arguments[2])):arguments.length&&p("Invalid parameters");return(isNaN(s)||s<0||2<s)&&p("Invalid parameters"),r.type=s,void 0===t?((isNaN(o)||o<0||65535<s)&&p("Invalid parameters"),r.ppqn=o):(24!=t&&25!=t&&29!=t&&30!=t&&p("Invalid parameters"),(isNaN(i)||i<0||255<s)&&p("Invalid parameters"),r.fps=t,r.ppf=i),r}function c(t){if(!t.length)return 0;if(t.charCodeAt(0)<128)return t.charCodeAt(0);var i=127&t.charCodeAt(0);return i<<=7,t.charCodeAt(1)<128?i+t.charCodeAt(1):(i+=127&t.charCodeAt(1),i<<=7,t.charCodeAt(2)<128?i+t.charCodeAt(2):(i+=127&t.charCodeAt(2),i<<=7,t.charCodeAt(3)<128?i+t.charCodeAt(3):void p("Corrupted MIDI track")))}function _(t){switch(240&t){case 128:case 144:case 160:case 176:case 224:return 2;case 192:case 208:return 1;default:p("Corrupted MIDI track")}}function l(t,i){var r;if(this.sub[t])return this.sub[t](t,i);for("string"==typeof t&&4==t.length||p("Invalid chunk type: "+t),r=0;r<t.length;r++)(t.charCodeAt(r)<0||255<t.charCodeAt(r))&&p("Invalid chunk type: "+t);for("string"!=typeof i&&p("Invalid data type: "+i),r=0;r<i.length;r++)(i.charCodeAt(r)<0||255<i.charCodeAt(r))&&p("Invalid data character: "+i[r]);this.type=t,this.data=i}function g(t){if(void((this._orig=this)._tick=0)!==t)for(var i,r,s,o=0,n=0,h="";n<t.length;)i=c(t.substr(n,4)),n++,127<i&&n++,16383<i&&n++,2097151<i&&n++,o+=i,255==t.charCodeAt(n)?(r=t.substr(n,2),n+=2,s=c(t.substr(n,4)),n++,127<s&&n++,16383<s&&n++,2097151<s&&n++,this.push(new m(o,r,t.substr(n,s))),n+=s):240==t.charCodeAt(n)||247==t.charCodeAt(n)?(r=t.substr(n,1),n+=1,s=c(t.substr(n,4)),n++,127<s&&n++,16383<s&&n++,2097151<s&&n++,this.push(new m(o,r,t.substr(n,s))),n+=s):128&t.charCodeAt(n)?(h=t.substr(n,1),n+=1,s=_(h.charCodeAt(0)),this.push(new m(o,h,t.substr(n,s))),n+=s):128&h.charCodeAt(0)&&(s=_(h.charCodeAt(0)),this.push(new m(o,h,t.substr(n,s))),n+=s);else this.push(new m(0,"ÿ/",""))}function C(t){var i={0:0,3:1,2:2,84:3,81:4,88:5,89:6,32:7,33:7,6:8,4:9,1:16,5:16,127:17,47:20}[t.ff];if(void 0!==i)return i;if(t.length){var r=t[0]>>4;if(void 0!==(i={8:10,15:11,11:12,12:13,10:15,13:15,14:15}[r]))return i;if(9==r)return t[1]?14:10}return 18}function i(t,i,r){this._orig=t,this._chan=i,this._tick=r}function m(t,i,r){var s;if(this.tt=t,this.status=i,this.data=r,255==i.charCodeAt(0))s=a.MIDI.smf(i.charCodeAt(1),r);else{for(var o=[i.charCodeAt(0)],n=0;n<r.length;n++)o.push(r.charCodeAt(n));s=a.MIDI(o)}return s.tt=t,s}function y(){var t,i=new a.Widget;for(var r in i._info.name="MIDI Player",i._info.manufacturer="Jazz-Soft",i._info.version=s,i.playing=!1,i._loop=0,i._data=[],i._pos=0,i._ms=0,i._tick=(t=i,function(){t.tick()}),y.prototype)y.prototype.hasOwnProperty(r)&&(i[r]=y.prototype[r]);return i}});