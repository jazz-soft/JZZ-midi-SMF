!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r:"function"==typeof define&&define.amd?define("JZZ.midi.SMF",["JZZ"],r):r(JZZ)}(0,function(a){if(!a.MIDI.SMF){var o="1.0.9",i=a.lib.now;u.version=function(){return o},((u.prototype=[]).constructor=u).prototype.copy=function(){var t=new u;t.type=this.type,t.ppqn=this.ppqn,t.fps=this.fps,t.ppf=this.ppf,t.rmi=this.rmi,t.ntrk=this.ntrk;for(var r=0;r<this.length;r++)t.push(this[r].copy());return t},u.prototype.load=function(t){"RIFF"==t.substr(0,4)&&"RMIDdata"==t.substr(8,8)&&(this.rmi=!0,t=t.substr(20,t.charCodeAt(16)+256*t.charCodeAt(17)+65536*t.charCodeAt(18)+16777216*t.charCodeAt(19))),this.loadSMF(t)};var h="MThd"+String.fromCharCode(0)+String.fromCharCode(0)+String.fromCharCode(0)+String.fromCharCode(6);u.prototype.loadSMF=function(t){t.substr(0,8)!=h&&p("Not a MIDI file"),this.type=16*t.charCodeAt(8)+t.charCodeAt(9),this.ntrk=16*t.charCodeAt(10)+t.charCodeAt(11),127<t.charCodeAt(12)?(this.fps=256-t.charCodeAt(12),this.ppf=t.charCodeAt(13)):this.ppqn=256*t.charCodeAt(12)+t.charCodeAt(13),(2<this.type||0==this.type&&1<this.ntrk||!this.ppf&&!this.ppqn)&&p("Invalid MIDI header");var r=0,i=14;for(this.warn=[];i<t.length-8;){var o=t.substr(i,4);"MTrk"==o&&r++;var n=(t.charCodeAt(i+4)<<24)+(t.charCodeAt(i+5)<<16)+(t.charCodeAt(i+6)<<8)+t.charCodeAt(i+7);i+=8;var s=t.substr(i,n);this.push(new C(o,s)),i+=n}r!=this.ntrk&&p("Corrupted MIDI file"),i<t.length&&this.warn.push(["extra",t.length-i]),i>t.length&&this.warn.push(["missing",i-t.length])},u.prototype.dump=function(t){var r="";if(t)return"RIFF"+d((r=this.dump()).length+12)+"RMIDdata"+d(r.length)+r;for(var i=this.ntrk=0;i<this.length;i++)this[i]instanceof g&&this.ntrk++,r+=this[i].dump();return r=(this.ppqn?n(this.ppqn):String.fromCharCode(256-this.fps)+String.fromCharCode(this.ppf))+r,r=h+String.fromCharCode(0)+String.fromCharCode(this.type)+n(this.ntrk)+r},u.prototype.toString=function(){var t;for(t=this.ntrk=0;t<this.length;t++)this[t]instanceof g&&this.ntrk++;var r=["SMF:","  type: "+this.type];for(this.ppqn?r.push("  ppqn: "+this.ppqn):r.push("  fps: "+this.fps,"  ppf: "+this.ppf),r.push("  tracks: "+this.ntrk),t=0;t<this.length;t++)r.push(this[t].toString());return r.join("\n")},u.prototype.player=function(){var t,r,i=new v;i.ppqn=this.ppqn,i.fps=this.fps,i.ppf=this.ppf;var o,n=[],s=0,h=0;for(t=0;t<this.length;t++)this[t]instanceof g&&n.push(this[t]);if(2==this.type)for(t=0;t<n.length;t++){for(r=0;r<n[t].length;r++)(o=a.MIDI(n[t][r])).track=t,h=o.tt+s,o.tt=h,i._data.push(o);s=h}else{var e=[];for(t=0;t<n.length;t++)e[t]=0;for(;;){var p=!0;for(t=0;t<n.length;t++){for(;e[t]<n[t].length&&n[t][e[t]].tt==h;)(o=a.MIDI(n[t][e[t]])).track=t,i._data.push(o),e[t]++;e[t]>=n[t].length||(p&&(s=n[t][e[t]].tt),p=!1,s>n[t][e[t]].tt&&(s=n[t][e[t]].tt))}if(h=s,p)break}}return i.ppqn?i.mul=i.ppqn/500:i.mul=i.fps*i.ppf/1e3,i._duration=h,i},(((u.Chunk=C).prototype=[]).constructor=C).prototype.copy=function(){return new C(this.type,this.data)},C.prototype.sub={MThd:function(){p("Illegal chunk type: MThd")},MTrk:function(t,r){return new g(r)}},C.prototype.dump=function(){return this.type+f(this.data.length)+this.data},C.prototype.toString=function(){return this.type+": "+this.data.length+" bytes"},(((u.MTrk=g).prototype=[]).constructor=g).prototype.copy=function(){for(var t=new g,r=t.length=0;r<this.length;r++)t.push(new a.MIDI(this[r]));return t},g.prototype.dump=function(){var t,r,i="",o=0,n="";for(t=0;t<this.length;t++)if(i+=s(this[t].tt-o),o=this[t].tt,void 0!==this[t].dd)i+="ÿ",i+=String.fromCharCode(this[t].ff),i+=s(this[t].dd.length),i+=this[t].dd;else if(240==this[t][0]||247==this[t][0])for(i+=String.fromCharCode(this[t][0]),i+=s(this[t].length-1),r=1;r<this[t].length;r++)i+=String.fromCharCode(this[t][r]);else for(this[t][0]!=n&&(n=this[t][0],i+=String.fromCharCode(this[t][0])),r=1;r<this[t].length;r++)i+=String.fromCharCode(this[t][r]);return"MTrk"+f(i.length)+i},g.prototype.toString=function(){for(var t=["MTrk:"],r=0;r<this.length;r++)t.push(this[r].tt+": "+this[r].toString());return t.join("\n  ")},g.prototype.add=function(t,r){if(t=parseInt(t),(isNaN(t)||t<0)&&p("Invalid parameter"),(r=a.MIDI(r)).tt=t,this[this.length-1].tt<t&&(this[this.length-1].tt=t),47==r.ff||255==r[0])return this;var i,o=_(r);for(i=0;i<this.length&&!(this[i].tt>t)&&!(this[i].tt==t&&_(this[i])>o);i++);return this.splice(i,0,r),this},g.prototype.send=function(t){this._orig.add(this._tick,t)},g.prototype.tick=function(t){if(t!=parseInt(t)||t<0)throw RangeError("Bad tick value: "+t);if(!t)return this;var r=function(){};r.prototype=this._orig;var i=new r;return i._tick=this._tick+t,i},g.prototype.note=function(t,r,i,o){return this.noteOn(t,r,i),0<o&&this.tick(o).noteOff(t,r),this},g.prototype.ch=function(t){if(void 0===t)return this;if(t!=parseInt(t)||t<0||15<t)throw RangeError("Bad channel value: "+t+" (must be from 0 to 15)");return new r(this._orig,t,this._tick)},(r.prototype=new g).tick=function(t){if(t!=parseInt(t)||t<0)throw RangeError("Bad tick value: "+t);return t?new r(this._orig,this._chan,this._tick+t):this},r.prototype.ch=function(t){if(void 0===t)return this._orig.tick(this._tick);if(t!=parseInt(t)||t<0||15<t)throw RangeError("Bad channel value: "+t+" (must be from 0 to 15)");return t==this._chan?this:new r(this._orig,t,this._tick)},r.prototype.note=function(t,r,i){return this.noteOn(t,r),i&&this.tick(i).noteOff(t),this},a.lib.copyMidiHelpers(g,r),v.prototype.onEnd=function(){},v.prototype.onData=function(){},v.prototype.loop=function(t){t==parseInt(t)&&0<t?this._loop=t:this._loop=t?-1:0},v.prototype.play=function(){this.event=void 0,this.playing=!0,this.paused=!1,this._ptr=0,this._pos=0,this._p0=0,this._t0=i(),this.tick()},v.prototype.stop=function(){this._pos=0,this.event="stop",this.paused=void 0},v.prototype.pause=function(){this.event="pause"},v.prototype.resume=function(){this.playing||(this.paused?(this.event=void 0,this._t0=i(),this.playing=!0,this.paused=!1,this.tick()):this.play())},v.prototype.sndOff=function(){for(var t=0;t<16;t++)this._emit(a.MIDI.allSoundOff(t))},v.prototype.tick=function(){var t,r=i();for(this._pos=this._p0+(r-this._t0)*this.mul;this._ptr<this._data.length&&!((t=this._data[this._ptr]).tt>this._pos);this._ptr++)81==t.ff&&this.ppqn&&(this.mul=1e3*this.ppqn/((t.dd.charCodeAt(0)<<16)+(t.dd.charCodeAt(1)<<8)+t.dd.charCodeAt(2)),this._p0=this._pos-(r-this._t0)*this.mul),this._emit(t);this._ptr>=this._data.length&&(this._loop&&-1!=this._loop&&this._loop--,this._loop?(this._ptr=0,this._p0=0,this._t0=r):this.stop(),this.onEnd()),"stop"==this.event&&(this.playing=!1,this.paused=!1,this._pos=0,this._ptr=0,this.sndOff(),this.event=void 0),"pause"==this.event&&(this.playing=!1,this.paused=!0,this._pos>=this._duration&&(this._pos=this._duration-1),this._p0=this._pos,this.sndOff(),this.event=void 0),this.playing&&a.lib.schedule(this._tick)},v.prototype.duration=function(){return this._duration},v.prototype.position=function(){return this._pos},v.prototype.jump=function(t){isNaN(parseFloat(t))&&p("Not a number: "+t),t<0&&(t=0),t>=this._duration&&(t=this._duration-1),this._pos=t,this._p0=t,this._t0=i(),this.playing||(this.paused=!!t),this._toPos(),this.playing&&this.sndOff()},v.prototype._toPos=function(){for(this._ptr=0;this._ptr<this._data.length&&(e=this._data[this._ptr],!(e.tt>=this._pos));this._ptr++)81==e.ff&&this.ppqn&&(this.mul=1e3*this.ppqn/((e.dd.charCodeAt(0)<<16)+(e.dd.charCodeAt(1)<<8)+e.dd.charCodeAt(2)),this._p0=this._pos-(i()-this._t0)*this.mul)},a.MIDI.SMF=u}function p(t){throw new Error(t)}function s(t){var r="";return 2097151<t&&(r+=String.fromCharCode(128+(t>>21&127))),16383<t&&(r+=String.fromCharCode(128+(t>>14&127))),127<t&&(r+=String.fromCharCode(128+(t>>7&127))),r+=String.fromCharCode(127&t)}function n(t){return String.fromCharCode(t>>8)+String.fromCharCode(255&t)}function f(t){return String.fromCharCode(t>>24&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t)}function d(t){return String.fromCharCode(255&t)+String.fromCharCode(t>>8&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>24&255)}function u(){var t,r,i=this instanceof u?this:i=new u,o=1,n=96;if(1==arguments.length){if(arguments[0]instanceof u)return arguments[0].copy();if("string"==typeof arguments[0]&&"0"!=arguments[0]&&"1"!=arguments[0]&&"2"!=arguments[0])return i.load(arguments[0]),i;o=parseInt(arguments[0])}else 2==arguments.length?(o=parseInt(arguments[0]),n=parseInt(arguments[1])):3==arguments.length?(o=parseInt(arguments[0]),t=parseInt(arguments[1]),r=parseInt(arguments[2])):arguments.length&&p("Invalid parameters");return(isNaN(o)||o<0||2<o)&&p("Invalid parameters"),i.type=o,void 0===t?((isNaN(n)||n<0||65535<o)&&p("Invalid parameters"),i.ppqn=n):(24!=t&&25!=t&&29!=t&&30!=t&&p("Invalid parameters"),(isNaN(r)||r<0||255<o)&&p("Invalid parameters"),i.fps=t,i.ppf=r),i}function c(t){if(!t.length)return 0;if(t.charCodeAt(0)<128)return t.charCodeAt(0);var r=127&t.charCodeAt(0);return r<<=7,t.charCodeAt(1)<128?r+t.charCodeAt(1):(r+=127&t.charCodeAt(1),r<<=7,t.charCodeAt(2)<128?r+t.charCodeAt(2):(r+=127&t.charCodeAt(2),r<<=7,t.charCodeAt(3)<128?r+t.charCodeAt(3):void p("Corrupted MIDI track")))}function l(t){switch(240&t){case 128:case 144:case 160:case 176:case 224:return 2;case 192:case 208:return 1;default:p("Corrupted MIDI track")}}function C(t,r){var i;if(this.sub[t])return this.sub[t](t,r);for("string"==typeof t&&4==t.length||p("Invalid chunk type: "+t),i=0;i<t.length;i++)(t.charCodeAt(i)<0||255<t.charCodeAt(i))&&p("Invalid chunk type: "+t);for("string"!=typeof r&&p("Invalid data type: "+r),i=0;i<r.length;i++)(r.charCodeAt(i)<0||255<r.charCodeAt(i))&&p("Invalid data character: "+r[i]);this.type=t,this.data=r}function g(t){if(void((this._orig=this)._tick=0)!==t)for(var r,i,o,n=0,s=0,h="";s<t.length;)r=c(t.substr(s,4)),s++,127<r&&s++,16383<r&&s++,2097151<r&&s++,n+=r,255==t.charCodeAt(s)?(i=t.substr(s,2),s+=2,o=c(t.substr(s,4)),s++,127<o&&s++,16383<o&&s++,2097151<o&&s++,this.push(new y(n,i,t.substr(s,o))),s+=o):240==t.charCodeAt(s)||247==t.charCodeAt(s)?(i=t.substr(s,1),s+=1,o=c(t.substr(s,4)),s++,127<o&&s++,16383<o&&s++,2097151<o&&s++,this.push(new y(n,i,t.substr(s,o))),s+=o):128&t.charCodeAt(s)?(h=t.substr(s,1),s+=1,o=l(h.charCodeAt(0)),this.push(new y(n,h,t.substr(s,o))),s+=o):128&h.charCodeAt(0)&&(o=l(h.charCodeAt(0)),this.push(new y(n,h,t.substr(s,o))),s+=o);else this.push(new y(0,"ÿ/",""))}function _(t){var r={0:0,3:1,2:2,84:3,81:4,88:5,89:6,32:7,33:7,6:8,4:9,1:16,5:16,127:17,47:20}[t.ff];if(void 0!==r)return r;if(t.length){var i=t[0]>>4;if(void 0!==(r={8:10,15:11,11:12,12:13,10:15,13:15,14:15}[i]))return r;if(9==i)return t[1]?14:10}return 18}function r(t,r,i){this._orig=t,this._chan=r,this._tick=i}function y(t,r,i){var o;if(this.tt=t,this.status=r,this.data=i,255==r.charCodeAt(0))o=a.MIDI.smf(r.charCodeAt(1),i);else{for(var n=[r.charCodeAt(0)],s=0;s<i.length;s++)n.push(i.charCodeAt(s));o=a.MIDI(n)}return o.tt=t,o}function v(){var t,r=new a.Widget;for(var i in r._info.name="MIDI Player",r._info.manufacturer="Jazz-Soft",r._info.version=o,r.playing=!1,r._loop=0,r._data=[],r._pos=0,r._tick=(t=r,function(){t.tick()}),v.prototype)v.prototype.hasOwnProperty(i)&&(r[i]=v.prototype[i]);return r}});