!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i:"function"==typeof define&&define.amd?define("JZZ.midi.SMF",["JZZ"],i):i(JZZ)}(0,function(s){if(!s.MIDI.SMF){var a=s.lib.now;((o.prototype=[]).constructor=o).prototype.dup=function(t){p("Copy-constructor not yet implemented")},o.prototype.load=function(t){"RIFF"==t.substr(0,4)&&"RMIDdata"==t.substr(8,8)&&(t=t.substr(20,t.charCodeAt(16)+256*t.charCodeAt(17)+65536*t.charCodeAt(18)+16777216*t.charCodeAt(19))),this.loadSMF(t)},o.prototype.loadSMF=function(t){"MThd\0\0\0"!=t.substr(0,8)&&p("Not a MIDI file"),this.type=16*t.charCodeAt(8)+t.charCodeAt(9),this.ntrk=16*t.charCodeAt(10)+t.charCodeAt(11),127<t.charCodeAt(12)?(this.fps=256-t.charCodeAt(12),this.ppf=t.charCodeAt(13)):this.ppqn=256*t.charCodeAt(12)+t.charCodeAt(13),(2<this.type||0==this.type&&1<this.ntrk||!this.ppf&&!this.ppqn)&&p("Invalid MIDI header");for(var i=0,r=14;r<t.length;){var e=t.substr(r,4);"MTrk"==e&&i++;var s=(t.charCodeAt(r+4)<<24)+(t.charCodeAt(r+5)<<16)+(t.charCodeAt(r+6)<<8)+t.charCodeAt(r+7);r+=8;var a=t.substr(r,s);this.push(new d(e,a)),r+=s}r==t.length&&i==this.ntrk||p("Corrupted MIDI file")},o.prototype.dump=function(){for(var t="",i=0,r=0;r<this.length;r++)this[r]instanceof u&&i++,t+=this[r].dump();return t=(this.ppqn?String.fromCharCode(this.ppqn>>8)+String.fromCharCode(255&this.ppqn):String.fromCharCode(256-this.fps)+String.fromCharCode(this.ppf))+t,t="MThd\0\0\0\0"+String.fromCharCode(this.type)+String.fromCharCode(i>>8)+String.fromCharCode(255&i)+t},o.prototype.toString=function(){return"Midi File "+this.length},o.prototype.player=function(){var t,i=new c;i.ppqn=this.ppqn,i.fps=this.fps,i.ppf=this.ppf;var r=[];for(t=0;t<this.length;t++)this[t]instanceof u&&r.push(this[t]);2==this.type&&p("Playing MIDI file type 2 not yet implemented");var e=[];for(t=0;t<r.length;t++)e[t]=0;for(var s=0;;){var a,o=!0;for(t=0;t<r.length;t++){for(;e[t]<r[t].length&&r[t][e[t]].time==s;){var h=r[t][e[t]],n=new f;for(var d in h)h.hasOwnProperty(d)&&(n[d]=h[d]);n.track=t,i._data.push(n),e[t]++}e[t]>=r[t].length||(o&&(a=r[t][e[t]].time),o=!1,a>r[t][e[t]].time&&(a=r[t][e[t]].time))}if(s=a,o)break}return i._duration=s,i},((d.prototype=[]).constructor=d).prototype.sub={MThd:function(){p("Illegal chunk type: MThd")},MTrk:function(t,i){return new u(i)}},d.prototype.dump=function(){var t=this.data.length;return this.type+String.fromCharCode(t>>24&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t)+this.data},((u.prototype=[]).constructor=u).prototype.dump=function(){for(var t,i,r="",e=0,s="",a=0;a<this.length;a++)t=this[a].time-e,e=this[a].time,2097151<t&&(r+=String.fromCharCode(128+(t>>21&127))),16383<t&&(r+=String.fromCharCode(128+(t>>14&127))),127<t&&(r+=String.fromCharCode(128+(t>>7&127))),r+=String.fromCharCode(127&t),255==this[a].status.charCodeAt(0)||240==this[a].status.charCodeAt(0)||247==this[a].status.charCodeAt(0)?(r+=this[a].status,2097151<(i=this[a].data.length)&&(r+=String.fromCharCode(128+(i>>21&127))),16383<i&&(r+=String.fromCharCode(128+(i>>14&127))),127<i&&(r+=String.fromCharCode(128+(i>>7&127))),r+=String.fromCharCode(127&i)):this[a].status!=s&&(s=this[a].status,r+=this[a].status),r+=this[a].data;return i=r.length,"MTrk"+String.fromCharCode(i>>24&255)+String.fromCharCode(i>>16&255)+String.fromCharCode(i>>8&255)+String.fromCharCode(255&i)+r},u.prototype.getTime=function(){return this[this.length-1].time},u.prototype.setTime=function(t){t=parseInt(t),(isNaN(t)||t<0)&&p("Invalid parameter");var i=this[this.length-1];t<i.time&&p("not yet implemented"),i.time=t},u.prototype.addEvent=function(t,i,r){var e;t=parseInt(t),(isNaN(t)||t<0)&&p("Invalid parameter"),i=i.toString(),r=r.toString(),this.getTime()<t&&this.setTime(t);var s=this.eventOrder(i,r);for(e=0;e<this.length&&!(this[e].time>t)&&!(this[e].time==t&&this.eventOrder(this[e].status,this[e].data)>s);e++);this.splice(e,0,new f(t,i,r))},u.prototype.addMidi=function(){for(var t=arguments[0],i=[],r=1;r<arguments.length;r++)i.push(arguments[r]);var e=JZZ_.MIDI.apply(void 0,i).data(),s=e.charCodeAt(0);(s<128||254<s)&&p("Invalid MIDI message");var a=JZZ_.Midi.len(s);void 0!==a&&a!=e.length&&p("Invalid MIDI message"),this.addEvent(t,e.substr(0,1),e.substr(1))},u.prototype.addNote=function(t,i,r,e,s){var a=parseInt(r);isNaN(a)&&(a=parseInt(JZZ_.Midi[r])),(isNaN(a)||a<0||127<a)&&p("Invalid parameter"),i=parseInt(i),(isNaN(i)||i<0||15<i)&&p("Invalid parameter"),void 0===s&&(s=0),s=parseInt(s),(isNaN(s)||s<0)&&p("Invalid parameter"),void 0===e&&(e=127),e=parseInt(e),(isNaN(e)||e<0||127<e)&&p("Invalid parameter"),this.addMidi(t,144+i,a,e),s&&this.addMidi(t+s,144+i,a,0)},u.prototype.addName=function(t,i){this.addEvent(t,"ÿ",i)},u.prototype.addText=function(t,i){this.addEvent(t,"ÿ",i)},u.prototype.addTempo=function(t,i){var r=Math.round(6e7/i),e=String.fromCharCode(255&r>>16)+String.fromCharCode(255&r>>8)+String.fromCharCode(255&r);this.addEvent(t,"ÿQ",e)},f.prototype.toString=function(){var t,i,r=this.status.charCodeAt(0);if(127<r&&255!=r&&240!=r&&247!=r)return JZZ_.MIDI(this.status+this.data).toString();if(255==r){var e=this.status.charCodeAt(1);if(t="ff"+(15<e?"":"0")+e.toString(16)+" ",0==e)return t+="Sequence number: "+this.data.charCodeAt(0);if(e<10)return t+={1:"Text",2:"Copyright",3:"Track name",4:"Instrument",5:"Lyrics",6:"Marker",7:"Cue point",8:"Program name",9:"Device name"}[e],t+=": "+this.data;if(32==e)t+="MIDI channel: ";else if(33==e)t+="MIDI port: ";else{if(47==e)return t+="End of track";if(81==e){var s=65536*this.data.charCodeAt(0)+256*this.data.charCodeAt(1)+this.data.charCodeAt(2);return t+="Tempo: "+Math.round(6e9/s)/100+" bpm"}if(84==e){for(t+="SMPTE offset: "+(9<this.data.charCodeAt(0)?"":"0")+this.data.charCodeAt(0).toString(),i=1;i<this.data.length;i++)t+=":"+(9<this.data.charCodeAt(i)?"":"0")+this.data.charCodeAt(i);return t}if(88==e){var a=1<<this.data.charCodeAt(1);return t+="Time signature: "+this.data.charCodeAt(0)+"/"+a,t+=" "+this.data.charCodeAt(2)+" "+this.data.charCodeAt(3)}if(89==e){t+="Key signature: ";var o=this.data.charCodeAt(0),h=this.data.charCodeAt(1);if(128&o&&(o-=256),0<=(o+=7)&&o<=14&&0<=h&&h<=1)return h&&(o+=3),t+=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#","G#","D#","A#"][o],h&&(t+="min"),t}else 127==e&&(t+="Proprietary event: ")}}else t=240==r?"SysEx: f0":247==r?"SysEx cont.:":(15<r?"":"0")+r.toString(16);for(i=0;i<this.data.length;i++)t+=" "+(15<this.data.charCodeAt(i)?"":"0")+this.data.charCodeAt(i).toString(16);return t},c.prototype.onEnd=function(){},c.prototype.onData=function(){},c.prototype.loop=function(t){this.looped=!!t},c.prototype.play=function(){this.ppqn?this.mul=this.ppqn/500:this.mul=this.fps*this.ppf/1e3,this.event=void 0,this.playing=!0,this.paused=!1,this._ptr=0,this._pos=0,this._p0=0,this._t0=a(),this.tick()},c.prototype.stop=function(){this._pos=0,this.event="stop",this.paused=void 0},c.prototype.pause=function(){this.event="pause"},c.prototype.resume=function(){this.playing||(this.paused?(this.event=void 0,this._t0=a(),this.playing=!0,this.paused=!1,this.tick()):this.play())},c.prototype.sndOff=function(){for(var t=0;t<16;t++)this._emit(s.MIDI.allSoundOff(t))},c.prototype.tick=function(){var t,i,r=a();for(this._pos=this._p0+(r-this._t0)*this.mul;this._ptr<this._data.length&&!((t=this._data[this._ptr]).time>this._pos);this._ptr++)i={},"ÿQ"==t.status&&this.ppqn?(this.mul=1e3*this.ppqn/((t.data.charCodeAt(0)<<16)+(t.data.charCodeAt(1)<<8)+t.data.charCodeAt(2)),this._p0=this._pos-(r-this._t0)*this.mul):247==t.status.charCodeAt(0)?i.midi=t.data:255!=t.status.charCodeAt(0)?i.midi=t.status+t.data:(i.status=t.status,i.data=t.data),i.track=t.track,void 0!==t.user&&(i.user=t.user),i.midi?this._emit(C(i.midi)):this.onData(t);this._ptr>=this._data.length&&(this.looped?(this._ptr=0,this._p0=0,this._t0=r):this.stop(),this.onEnd()),"stop"==this.event&&(this.playing=!1,this.paused=!1,this._pos=0,this._ptr=0,this.sndOff(),this.event=void 0),"pause"==this.event&&(this.playing=!1,this.paused=!0,this._pos>=this._duration&&(this._pos=this._duration-1),this._p0=this._pos,this.sndOff(),this.event=void 0),this.playing&&s.lib.schedule(this._tick)},c.prototype.duration=function(){return this._duration},c.prototype.position=function(){return this._pos},c.prototype.jump=function(t){isNaN(parseFloat(t))&&p("Not a number: "+t),t<0&&(t=0),t>=this._duration&&(t=this._duration-1),this._pos=t,this._p0=t,this._t0=a(),this.playing||(this.paused=!!t),this._toPos(),this.playing&&this.sndOff()},c.prototype._toPos=function(){for(this._ptr=0;this._ptr<this._data.length&&(e=this._data[this._ptr],!(e.time>=this._pos));this._ptr++)"ÿQ"==e.status&&this.ppqn&&(this.mul=1e3*this.ppqn/((e.data.charCodeAt(0)<<16)+(e.data.charCodeAt(1)<<8)+e.data.charCodeAt(2)),this._p0=this._pos-(a()-this._t0)*this.mul)},s.MIDI.SMF=o}function p(t){throw new Error(t)}function o(){var t,i,r=1,e=96;if(1==arguments.length){if(arguments[0]instanceof o)return void this.dup(arguments[0]);if("string"==typeof arguments[0]&&"0"!=arguments[0]&&"1"!=arguments[0]&&"2"!=arguments[0])return void this.load(arguments[0]);r=parseInt(arguments[0])}else 2==arguments.length?(r=parseInt(arguments[0]),e=parseInt(arguments[1])):3==arguments.length?(r=parseInt(arguments[0]),t=parseInt(arguments[1]),i=parseInt(arguments[2])):arguments.length&&p("Invalid parameters");(isNaN(r)||r<0||2<r)&&p("Invalid parameters"),this.type=r,void 0===t?((isNaN(e)||e<0||65535<r)&&p("Invalid parameters"),this.ppqn=e):(24!=t&&25!=t&&29!=t&&30!=t&&p("Invalid parameters"),(isNaN(i)||i<0||255<r)&&p("Invalid parameters"),this.fps=t,this.ppf=i)}function h(t){if(t.charCodeAt(0)<128)return t.charCodeAt(0);var i=127&t.charCodeAt(0);return i<<=7,t.charCodeAt(1)<128?i+t.charCodeAt(1):(i+=127&t.charCodeAt(1),i<<=7,t.charCodeAt(2)<128?i+t.charCodeAt(2):(i+=127&t.charCodeAt(2),i<<=7,t.charCodeAt(3)<128?i+t.charCodeAt(3):void p("Corrupted MIDI track")))}function n(t){switch(240&t){case 128:case 144:case 160:case 176:case 224:return 2;case 192:case 208:return 1;default:p("Corrupted MIDI track")}}function d(t,i){if(this.sub[t])return this.sub[t](t,i);"string"==typeof t&&4==t.length||p("Invalid chunk type: "+t),this.type=t,this.data=i}function u(t){if(void 0!==t)for(var i,r,e,s=0,a=0,o="";a<t.length;)i=h(t.substr(a,4)),a++,127<i&&a++,16383<i&&a++,2097151<i&&a++,s+=i,255==t.charCodeAt(a)?(r=t.substr(a,2),a+=2,e=h(t.substr(a,4)),a++,127<e&&a++,16383<e&&a++,2097151<e&&a++,this.push(new f(s,r,t.substr(a,e))),a+=e):240==t.charCodeAt(a)||247==t.charCodeAt(a)?(r=t.substr(a,1),a+=1,e=h(t.substr(a,4)),a++,127<e&&a++,16383<e&&a++,2097151<e&&a++,this.push(new f(s,r,t.substr(a,e))),a+=e):128&t.charCodeAt(a)?(o=t.substr(a,1),a+=1,e=n(o.charCodeAt(0)),this.push(new f(s,o,t.substr(a,e))),a+=e):128&o.charCodeAt(0)&&(e=n(o.charCodeAt(0)),this.push(new f(s,o,t.substr(a,e))),a+=e);else this.push(new f(0,"ÿ/",""))}function f(t,i,r){this.time=t,this.status=i,this.data=r}function c(){var t,i=new s.Widget;for(var r in i.playing=!1,i.looped=!1,i._data=[],i._pos=0,i._tick=(t=i,function(){t.tick()}),c.prototype)c.prototype.hasOwnProperty(r)&&(i[r]=c.prototype[r]);return i}function C(t){var i,r=[];for(i=0;i<t.length;i++)r.push(t.charCodeAt(i));return s.MIDI(r)}});