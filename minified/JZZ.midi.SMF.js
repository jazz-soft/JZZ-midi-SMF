!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r:"function"==typeof define&&define.amd?define("JZZ.midi.SMF",["JZZ"],r):r(JZZ)}(0,function(p){if(!p.MIDI.SMF){var o="0.1.2",i=p.lib.now;((h.prototype=[]).constructor=h).prototype.dup=function(t){d("Copy-constructor not yet implemented")},h.prototype.load=function(t){"RIFF"==t.substr(0,4)&&"RMIDdata"==t.substr(8,8)&&(this.rmi=!0,t=t.substr(20,t.charCodeAt(16)+256*t.charCodeAt(17)+65536*t.charCodeAt(18)+16777216*t.charCodeAt(19))),this.loadSMF(t)},h.prototype.loadSMF=function(t){"MThd\0\0\0"!=t.substr(0,8)&&d("Not a MIDI file"),this.type=16*t.charCodeAt(8)+t.charCodeAt(9),this.ntrk=16*t.charCodeAt(10)+t.charCodeAt(11),127<t.charCodeAt(12)?(this.fps=256-t.charCodeAt(12),this.ppf=t.charCodeAt(13)):this.ppqn=256*t.charCodeAt(12)+t.charCodeAt(13),(2<this.type||0==this.type&&1<this.ntrk||!this.ppf&&!this.ppqn)&&d("Invalid MIDI header");for(var r=0,i=14;i<t.length;){var o=t.substr(i,4);"MTrk"==o&&r++;var s=(t.charCodeAt(i+4)<<24)+(t.charCodeAt(i+5)<<16)+(t.charCodeAt(i+6)<<8)+t.charCodeAt(i+7);i+=8;var e=t.substr(i,s);this.push(new f(o,e)),i+=s}i==t.length&&r==this.ntrk||d("Corrupted MIDI file")},h.prototype.dump=function(){for(var t="",r=0,i=0;i<this.length;i++)this[i]instanceof u&&r++,t+=this[i].dump();return t=(this.ppqn?String.fromCharCode(this.ppqn>>8)+String.fromCharCode(255&this.ppqn):String.fromCharCode(256-this.fps)+String.fromCharCode(this.ppf))+t,t="MThd\0\0\0\0"+String.fromCharCode(this.type)+String.fromCharCode(r>>8)+String.fromCharCode(255&r)+t},h.prototype.toString=function(){var t=["SMF:","  type: "+this.type];this.ppqn?t.push("  ppqn: "+this.ppqn):t.push("  fps: "+this.fps,"  ppf: "+this.ppf),t.push("  tracks: "+this.ntrk);for(var r=0;r<this.length;r++)t.push(this[r].toString());return t.join("\n")},h.prototype.player=function(){var t,r=new C;r.ppqn=this.ppqn,r.fps=this.fps,r.ppf=this.ppf;var i=[];for(t=0;t<this.length;t++)this[t]instanceof u&&i.push(this[t]);2==this.type&&d("Playing MIDI file type 2 not yet implemented");var o=[];for(t=0;t<i.length;t++)o[t]=0;for(var s=0;;){var e,h=!0;for(t=0;t<i.length;t++){for(;o[t]<i[t].length&&i[t][o[t]].tt==s;){var n=i[t][o[t]],a=p.MIDI(n);a.track=t,r._data.push(a),o[t]++}o[t]>=i[t].length||(h&&(e=i[t][o[t]].tt),h=!1,e>i[t][o[t]].tt&&(e=i[t][o[t]].tt))}if(s=e,h)break}return r._duration=s,r},((f.prototype=[]).constructor=f).prototype.sub={MThd:function(){d("Illegal chunk type: MThd")},MTrk:function(t,r){return new u(r)}},f.prototype.dump=function(){var t=this.data.length;return this.type+String.fromCharCode(t>>24&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t)+this.data},((u.prototype=[]).constructor=u).prototype.dump=function(){for(var t,r,i="",o=0,s="",e=0;e<this.length;e++)if(t=this[e].tt-o,o=this[e].tt,2097151<t&&(i+=String.fromCharCode(128+(t>>21&127))),16383<t&&(i+=String.fromCharCode(128+(t>>14&127))),127<t&&(i+=String.fromCharCode(128+(t>>7&127))),i+=String.fromCharCode(127&t),void 0!==this[e].dd)i+="ÿ",i+=String.fromCharCode(this[e].ff),2097151<(r=this[e].dd.length)&&(i+=String.fromCharCode(128+(r>>21&127))),16383<r&&(i+=String.fromCharCode(128+(r>>14&127))),127<r&&(i+=String.fromCharCode(128+(r>>7&127))),i+=String.fromCharCode(127&r),i+=this[e].dd;else if(240==this[e][0]||240==this[e][0]){i+=String.fromCharCode(this[e][0]),2097151<(r=this[e].length-1)&&(i+=String.fromCharCode(128+(r>>21&127))),16383<r&&(i+=String.fromCharCode(128+(r>>14&127))),127<r&&(i+=String.fromCharCode(128+(r>>7&127))),i+=String.fromCharCode(127&r);for(var h=1;h<this[e].length;h++)i+=String.fromCharCode(this[e][h])}else{this[e][0]!=s&&(s=this[e][0],i+=String.fromCharCode(this[e][0]));for(h=1;h<this[e].length;h++)i+=String.fromCharCode(this[e][h])}return r=i.length,"MTrk"+String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(255&r)+i},u.prototype.toString=function(){for(var t=["MTrk:"],r=0;r<this.length;r++)t.push(this[r].tt+": "+this[r].toString());return t.join("\n  ")},u.prototype.getTick=function(){return this[this.length-1].tt},u.prototype.setTick=function(t){t=parseInt(t),(isNaN(t)||t<0)&&d("Invalid parameter");var r=this[this.length-1];t<r.tt&&d("not yet implemented"),r.tt=t},u.prototype.addEvent=function(t,r,i){var o;t=parseInt(t),(isNaN(t)||t<0)&&d("Invalid parameter"),r=r.toString(),i=i.toString(),this.getTick()<t&&this.setTick(t);var s=this.eventOrder(r,i);for(o=0;o<this.length&&!(this[o].tt>t)&&!(this[o].tt==t&&this.eventOrder(this[o].status,this[o].data)>s);o++);this.splice(o,0,new c(t,r,i))},u.prototype.addMidi=function(){for(var t=arguments[0],r=[],i=1;i<arguments.length;i++)r.push(arguments[i]);var o=JZZ_.MIDI.apply(void 0,r).data(),s=o.charCodeAt(0);(s<128||254<s)&&d("Invalid MIDI message");var e=JZZ_.Midi.len(s);void 0!==e&&e!=o.length&&d("Invalid MIDI message"),this.addEvent(t,o.substr(0,1),o.substr(1))},u.prototype.addNote=function(t,r,i,o,s){var e=parseInt(i);isNaN(e)&&(e=parseInt(JZZ_.Midi[i])),(isNaN(e)||e<0||127<e)&&d("Invalid parameter"),r=parseInt(r),(isNaN(r)||r<0||15<r)&&d("Invalid parameter"),void 0===s&&(s=0),s=parseInt(s),(isNaN(s)||s<0)&&d("Invalid parameter"),void 0===o&&(o=127),o=parseInt(o),(isNaN(o)||o<0||127<o)&&d("Invalid parameter"),this.addMidi(t,144+r,e,o),s&&this.addMidi(t+s,144+r,e,0)},u.prototype.addName=function(t,r){this.addEvent(t,"ÿ",r)},u.prototype.addText=function(t,r){this.addEvent(t,"ÿ",r)},u.prototype.addTempo=function(t,r){var i=Math.round(6e7/r),o=String.fromCharCode(255&i>>16)+String.fromCharCode(255&i>>8)+String.fromCharCode(255&i);this.addEvent(t,"ÿQ",o)},C.prototype.onEnd=function(){},C.prototype.onData=function(){},C.prototype.loop=function(t){t==parseInt(t)&&0<t?this._loop=t:this._loop=t?-1:0},C.prototype.play=function(){this.ppqn?this.mul=this.ppqn/500:this.mul=this.fps*this.ppf/1e3,this.event=void 0,this.playing=!0,this.paused=!1,this._ptr=0,this._pos=0,this._p0=0,this._t0=i(),this.tick()},C.prototype.stop=function(){this._pos=0,this.event="stop",this.paused=void 0},C.prototype.pause=function(){this.event="pause"},C.prototype.resume=function(){this.playing||(this.paused?(this.event=void 0,this._t0=i(),this.playing=!0,this.paused=!1,this.tick()):this.play())},C.prototype.sndOff=function(){for(var t=0;t<16;t++)this._emit(p.MIDI.allSoundOff(t))},C.prototype.tick=function(){var t,r=i();for(this._pos=this._p0+(r-this._t0)*this.mul;this._ptr<this._data.length&&!((t=this._data[this._ptr]).tt>this._pos);this._ptr++)81==t.ff&&this.ppqn&&(this.mul=1e3*this.ppqn/((t.dd.charCodeAt(0)<<16)+(t.dd.charCodeAt(1)<<8)+t.dd.charCodeAt(2)),this._p0=this._pos-(r-this._t0)*this.mul),this._emit(t);this._ptr>=this._data.length&&(this._loop&&-1!=this._loop&&this._loop--,this._loop?(this._ptr=0,this._p0=0,this._t0=r):this.stop(),this.onEnd()),"stop"==this.event&&(this.playing=!1,this.paused=!1,this._pos=0,this._ptr=0,this.sndOff(),this.event=void 0),"pause"==this.event&&(this.playing=!1,this.paused=!0,this._pos>=this._duration&&(this._pos=this._duration-1),this._p0=this._pos,this.sndOff(),this.event=void 0),this.playing&&p.lib.schedule(this._tick)},C.prototype.duration=function(){return this._duration},C.prototype.position=function(){return this._pos},C.prototype.jump=function(t){isNaN(parseFloat(t))&&d("Not a number: "+t),t<0&&(t=0),t>=this._duration&&(t=this._duration-1),this._pos=t,this._p0=t,this._t0=i(),this.playing||(this.paused=!!t),this._toPos(),this.playing&&this.sndOff()},C.prototype._toPos=function(){for(this._ptr=0;this._ptr<this._data.length&&(e=this._data[this._ptr],!(e.tt>=this._pos));this._ptr++)"ÿQ"==e.status&&this.ppqn&&(this.mul=1e3*this.ppqn/((e.data.charCodeAt(0)<<16)+(e.data.charCodeAt(1)<<8)+e.data.charCodeAt(2)),this._p0=this._pos-(i()-this._t0)*this.mul)},p.MIDI.SMF=h}function d(t){throw new Error(t)}function h(){var t,r,i=this instanceof h?this:i=new h,o=1,s=96;if(1==arguments.length){if(arguments[0]instanceof h)return i.dup(arguments[0]),i;if("string"==typeof arguments[0]&&"0"!=arguments[0]&&"1"!=arguments[0]&&"2"!=arguments[0])return i.load(arguments[0]),i;o=parseInt(arguments[0])}else 2==arguments.length?(o=parseInt(arguments[0]),s=parseInt(arguments[1])):3==arguments.length?(o=parseInt(arguments[0]),t=parseInt(arguments[1]),r=parseInt(arguments[2])):arguments.length&&d("Invalid parameters");return(isNaN(o)||o<0||2<o)&&d("Invalid parameters"),i.type=o,void 0===t?((isNaN(s)||s<0||65535<o)&&d("Invalid parameters"),i.ppqn=s):(24!=t&&25!=t&&29!=t&&30!=t&&d("Invalid parameters"),(isNaN(r)||r<0||255<o)&&d("Invalid parameters"),i.fps=t,i.ppf=r),i}function n(t){if(t.charCodeAt(0)<128)return t.charCodeAt(0);var r=127&t.charCodeAt(0);return r<<=7,t.charCodeAt(1)<128?r+t.charCodeAt(1):(r+=127&t.charCodeAt(1),r<<=7,t.charCodeAt(2)<128?r+t.charCodeAt(2):(r+=127&t.charCodeAt(2),r<<=7,t.charCodeAt(3)<128?r+t.charCodeAt(3):void d("Corrupted MIDI track")))}function a(t){switch(240&t){case 128:case 144:case 160:case 176:case 224:return 2;case 192:case 208:return 1;default:d("Corrupted MIDI track")}}function f(t,r){if(this.sub[t])return this.sub[t](t,r);"string"==typeof t&&4==t.length||d("Invalid chunk type: "+t),this.type=t,this.data=r}function u(t){if(void 0!==t)for(var r,i,o,s=0,e=0,h="";e<t.length;)r=n(t.substr(e,4)),e++,127<r&&e++,16383<r&&e++,2097151<r&&e++,s+=r,255==t.charCodeAt(e)?(i=t.substr(e,2),e+=2,o=n(t.substr(e,4)),e++,127<o&&e++,16383<o&&e++,2097151<o&&e++,this.push(new c(s,i,t.substr(e,o))),e+=o):240==t.charCodeAt(e)||247==t.charCodeAt(e)?(i=t.substr(e,1),e+=1,o=n(t.substr(e,4)),e++,127<o&&e++,16383<o&&e++,2097151<o&&e++,this.push(new c(s,i,t.substr(e,o))),e+=o):128&t.charCodeAt(e)?(h=t.substr(e,1),e+=1,o=a(h.charCodeAt(0)),this.push(new c(s,h,t.substr(e,o))),e+=o):128&h.charCodeAt(0)&&(o=a(h.charCodeAt(0)),this.push(new c(s,h,t.substr(e,o))),e+=o);else this.push(new c(0,"ÿ/",""))}function c(t,r,i){var o;if(this.tt=t,this.status=r,this.data=i,255==r.charCodeAt(0))o=p.MIDI.smf(r.charCodeAt(1),i);else{for(var s=[r.charCodeAt(0)],e=0;e<i.length;e++)s.push(i.charCodeAt(e));o=p.MIDI(s)}return o.tt=t,o}function C(){var t,r=new p.Widget;for(var i in r._info.name="MIDI Player",r._info.manufacturer="Jazz-Soft",r._info.version=o,r.playing=!1,r._loop=0,r._data=[],r._pos=0,r._tick=(t=r,function(){t.tick()}),C.prototype)C.prototype.hasOwnProperty(i)&&(r[i]=C.prototype[i]);return r}});